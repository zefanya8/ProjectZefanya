<!DOCTYPE html>
<html>
<head>
    <title>Form Inspeksi Pekerjaan Castable</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        h1, h2 { color: #2c3e50; text-align: center; }
        .form-container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .titik-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 20px; }
        button { background-color: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; }
        #errorMessage { color: #e74c3c; margin-top: 5px; text-align: center; }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>Form Inspeksi Pekerjaan Castable</h1>
        <form id="inspeksiForm">
            <div class="form-group">
                <label for="areaPekerjaan">Area Pekerjaan *</label>
                <select id="areaPekerjaan" required>
                    <option value="">-- Pilih Area --</option>
                    <option value="Cooler">Cooler</option>
                    <option value="KOH">KOH</option>
                </select>
            </div>

            <h2>Titik Pekerjaan</h2>
            <div class="titik-container" id="titikContainer"></div>

            <button type="submit">Simpan Data</button>
            <div id="errorMessage"></div>
        </form>
    </div>

    <script>
        // ========== KONFIGURASI ==========
        const JENIS_PEKERJAAN = ['Bongkar Casting', 'Anchoring', 'Insulating'];
        const JUMLAH_TITIK = 5;
        
        // GANTI DENGAN URL ANDA SETELAH DEPLOY
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby6QrTJfhMfP7UkjmEJkM0NMWTDqQG7bpBMUBtGdJ8h36zGrtZvwtwp0QSkVhPii6eX/exec';

        // ========== GENERATE FORM ==========
        const container = document.getElementById('titikContainer');
        for(let i = 1; i <= JUMLAH_TITIK; i++) {
            let pekerjaanHTML = JENIS_PEKERJAAN.map(jenis => `
                <div class="pekerjaan-item">
                    <label>${jenis}:</label>
                    <input type="number" id="titik-${i}-${jenis.toLowerCase().replace(' ', '-')}" min="0" max="100" step="0.1" placeholder="%">
                </div>
            `).join('');

            container.innerHTML += `
                <div class="titik-card">
                    <div class="titik-header">Titik ${i}</div>
                    ${pekerjaanHTML}
                </div>
            `;
        }

        // ========== HANDLE SUBMIT ==========
        document.getElementById('inspeksiForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDisplay = document.getElementById('errorMessage');
            errorDisplay.textContent = '';

            try {
                // Validasi
                const area = document.getElementById('areaPekerjaan').value;
                if(!area) throw new Error('Harap pilih Area Pekerjaan');

                // Siapkan data
                const data = { 'Area Pekerjaan': area };
                let totalTerisi = 0;

                for(let i = 1; i <= JUMLAH_TITIK; i++) {
                    const titikData = {};
                    JENIS_PEKERJAAN.forEach(jenis => {
                        const value = document.getElementById(`titik-${i}-${jenis.toLowerCase().replace(' ', '-')}`).value;
                        if(value) {
                            titikData[jenis] = parseFloat(value);
                            totalTerisi++;
                        }
                    });
                    if(Object.keys(titikData).length > 0) {
                        data[`Titik ${i}`] = JSON.stringify(titikData);
                    }
                }

                if(totalTerisi === 0) throw new Error('Harap isi minimal satu titik');

                // Kirim data (menggunakan XMLHttpRequest sebagai fallback)
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(data),
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) throw new Error('Gagal menyimpan');
                    alert('Data berhasil disimpan!');
                    document.getElementById('inspeksiForm').reset();
                } catch (fetchError) {
                    // Fallback ke XMLHttpRequest jika fetch gagal
                    await sendWithXHR(data);
                    alert('Data berhasil disimpan (via fallback)!');
                    document.getElementById('inspeksiForm').reset();
                }

            } catch(error) {
                errorDisplay.textContent = error.message;
                console.error('Error:', error);
            }
        });

        // Fallback dengan XMLHttpRequest
        function sendWithXHR(data) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', SCRIPT_URL);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onload = () => resolve(xhr.responseText);
                xhr.onerror = () => reject(new Error('Network error'));
                xhr.send(JSON.stringify(data));
            });
        }
    </script>
